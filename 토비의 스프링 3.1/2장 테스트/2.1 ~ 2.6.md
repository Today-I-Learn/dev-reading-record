# 토비의 스프링 3.1 - 2장 테스트

스프링이 개발자에게 제공하는 가장 중요한 가치 두가지는 객체지향과 테스트이다.
테스트 기술은 만들어진 코드를 확신할 수 있게 해주고, 변화에 유연하게 대처할 수 있는 자신감을 준다.

## 2.1 UserDaoTest 다시 보기

### 2.1.1 테스트의 유용성
만든 코드는 어떤 방법으로든 테스트해야 한다.
코드만 만들어놓고 잘 돌아가겠거니 하고 무책임하게 개발을 마치는 개발자는 아마도 없을 것이다.

처음과 동일한 기능을 수행함을 보장해줄 수 있는 방법에는 테스트를 통해 직접 기능을 동작시켜서 결과를 확인하는 방법이 유일하다.
테스트란 결국 내가 예상하고 의도했던 대로 코드가 정확히 동작하는지를 확인해서, 만든 코드를 확신할 수 있게 해주는 작업이다.
최종적으로 테스트가 성공하면 구현했던 코드의 모든 결함이 제거됐다는 확신을 얻을 수 있다.

### 웹을 통한 DAO 테스트 방법의 문제점
웹 화면을 통해 입출력 및 기능에 대한 결과를 확인하는 방법은 가장 흔히 쓰이는 방법이지만, DAO에 대한 테스트로서는 단점이 너무 많다.
DAO뿐만 아니라 서비스 클래스, 컨트롤러, JSP 뷰 등 모든 레이어의 기능을 다 만들고 나서야 테스트가 가능하다는점이 가장 큰 문제다.
그리고 정작 테스트할 대상뿐만 아니라 다른 코드 때문에 에러가 나거나 테스트가 실패할 수도 있다.
테스트하고 싶었던 건 UserDao였는데 다른 계층의 코드와 컴포넌트, 심지어 서버의 설정 상태까지 모두 테스트에 영향을 줄 수 있기 때문에
이런 방식으로 테스트하는 것은 번거롭고, 오류가 있을 때 빠르고 정확하게 대응하기가 힘들다는 문제가 있다.

### 작은 단위의 테스트
테스트하고자 하는 대상이 명확하다면 그 대상에만 집중해서 테스트하는 것이 바람직하다.
테스트의 관심이 다르다면 테스트할 대상을 분리하고 집중해서 접근해야 한다.
이렇게 작은 단위의 코드에 대해 테스트를 수행한 것을 **단위 테스트(unit test)** 라고 한다.

단위 테스트가 필요한 이유는 개발자가 설계하고 만든 코드가 원래 의도한 대로 동작하는지를 개발자 스스로 빨리 확인받기 위해서다.
확인의 대상과 조건이 간단하고 명확할수록 좋다. 그래서 작은 단위로 제한해서 테스트하는 것이 편리하다.

### 자동수행 테스트 코드
테스트는 자동으로 수행되도록 코드로 만들어지는 것이 중요하다.
자주 반복할 수 있다는 장점이 있다. 때문에 언제든 코드를 수정하고 나서 테스트를 해볼 수 있다.

### 지속적인 개선과 점진적인 개발을 위한 테스트
기능을 더 추가해가면서 그에 대한 테스트도 함께 추가하는 식으로 점진적인 개발이 가능하다.
새로운 기능도 기대한 대로 동작하는지 확인할 수 있고, 기존에 만들어둔 기능들이 새로운 기능을 추가하느라 수정한 코드에 영향을 받지 않고 잘 동작하는지를 확인할 수도 있다.

## 2.2 UserDaoTest 개선

### 2.2.1 테스트 검증의 자동화
개발 과정에서, 또는 유지보수를 하면서 기존 애플리케이션 코드에 수정을 할 때 마음의 평안을 얻고, 자신이 만지는 코드에 대해 항상 자신감을 가질 수 있으며,
새로 도입한 기술의 적용에 문제가 없는지 확인할 수 있는 가장 좋은 방법은 빠르게 실행 가능하고 스스로 테스트 수행과 기대하는 결과에 대한 확인까지 해주는 코드로 된 자동화 테스트를 만들어두는 것이다.

### 2.2.2 테스트의 효율적인 수행과 결과 관리
이미 자바에는 실용적인 테스트를 위한 도구가 여러가지 존재한다.
그중 JUnit은 유명한 테스트 지원 도구이고 자바로 단위 테스트를 만들 때 유용하게 쓸 수 있는 프레임워크이다.

## 2.3 개발자를 위한 테스팅 프레임워크 JUnit

### JUnit 프레임워크 사용 조건
- 메소드가 public으로 선언돼야 한다.
- 메소드에 @Test 애노테이션을 붙혀줘야 한다.

두가지 조건은 꼭 지켜져야 된다. 그리고 이왕이면 테스트의 의도가 무엇인지 알 수 있는 이름을 메소드명으로 작성하면 좋다.
JUnit은 예외가 발생하거나 asserthat()에서 실패하지 않고 테스트 메소드의 실행이 완료되면 성공했다고 인식한다.

### 2.3.1 JUnit 테스트 실행 방법
개발자 개인별는 IDE에서 JUnit 도구를 활용해서 테스트를 실행하는게 가장 편리하다.

여러 개발자가 만든 코드를 모두 통합해서 테스트를 수행해야 할 때는, 서버에서 모든 코드를 가져와 통합하고 빌드한 뒤에 테스트를 수행하는 것이 좋다.
이때는 빌드 스크립트를 이용해 JUnit 테스트를 실행하고 그 결과를 메일 등으로 통보받는 방법을 사용하면 된디.

### 2.3.2 테스트 결과의 일관성
반복적으로 테스트를 했을 때 테스트가 실패하기도 하고 성공하기도 한다면 이는 좋은 테스트라고 할 수가 없다.

코드에 변경사항이 없다면 테스트는 항상 동일한 결과를 내야 한다.
DB에 남아 있는 데이터와 같은 외부 환경에 영향을 받지 말아야 하는 것은 물론이고, 테스트를 실행하는 순서를 바꿔도 동일한 결과가 보장되도록 만들어야 한다.

### 2.3.3 포괄적인 테스트
테스트를 안 만드는 것도 위험한 일이지만, 성의 없이 테스트를 만드는 바람에 문제가 있는 코드인데도 테스트가 성공하게 만드는 건 더 위험하다.
특히 한 가지 결과만 검증하고 마는 것은 상당히 위험하다.

테스트를 작성할 때 부정적인 케이스를 먼저 만드는 습관을 들이는 게 좋다. 그렇다면 예외적인 상황을 빠뜨리지 않는 꼼꼼한 개발이 가능하다.

### 2.3.4 테스트가 이끄는 개발

#### 테스트 주도 개발
만들고자 하는 기능의 내용을 담고, 만들어진 코드를 검증도 해줄 수 있도록 테스트 코드를 먼저 만들고, 
테스트를 성공하게 해주는 코드를 작성하는 방식의 개발 방법을 **테스트 주도 개발(TDD : Test Driven Development)** 라고 한다.

코드에 대한 피드백을 매우 빠르게 받을 수 있고, 작성한 코드에 대한 확신을 가질 수 있다.
개발자는 자신감과 마음의 여유를 가질 수 있다.

TDD에서는 테스트 작성과 이를 성공시키는 코드 작성의 주기를 가능한 한 짧게 가져가도록 권장한다.
개발한 코드의 오류는 빨리 발견할수록 좋고, 미리미리 쉽게 발견할 수 있었던 사소한 문제도 나중에 많은 코드와 얽혀서 돌아가는 상황에서는 쉽게 찾지 못하는 경우가 많기 때문이다.

테스트를 작성하느라 개발시간이 늦춰진다고 생각할 수 있지만, 테스트 덕분에 오류를 빨리 잡아낼 수 있어서 전체적인 개발 속도는 오히려 빨라진다.

### 2.3.5 테스트 코드 개선
테스트 코드 자체가 이미 자신에 대한 테스트이기 때문에 테스트 결과가 일정하게 유지된다면 얼마든지 리팩토링을 해도 좋다.

### JUnit 프레임워크가 테스트를 수행하는 방식 (간단하게 7단계로 정리)
1. 테스트 클래스에서 @Test가 붙은 public이고 void형이며 파라미터가 없는 테스트 메소드를 모두 찾는다.
2. 테스트 클래스의 오브젝트를 하나 만든다.
3. @Before가 붙은 메소드가 있으면 실행한다.
4. @Test가 붙은 메소드를 하나 호출하고 테스트 결과를 저장해둔다.
5. @After가 붙은 메소드가 있으면 실행한다.
6. 나머지 테스트 메소드에 대해 2~5번을 반복한다.
7. 모든 테스트의 결과를 종합해서 돌려준다.

JUnit은 각 테스트 메소드를 실행할 때마다 테스트 클래스의 오브젝트를 새로 만든다.
각 테스트가 서로 영향을 주지 않고 독립적으로 실행됨을 확실히 보장해주기 위해서 이런 방식을 사용한다.

### 픽스쳐(fixture)
테스트를 수행하는 데 필요한 정보나 오브젝트를 **픽스쳐(fixture)** 라고 한다.

## 2.4 스프링 테스트 적용
테스트는 가능한 한 독립적으로 매번 새로운 오브젝트를 만들어서 사용하는 것이 원칙이다.
하지만 애플리케이션 컨텍스트처럼 생성에 많은 시간과 자원이 소모되는 경우에는 테스트 전체가 공유하는 오브젝트를 만들기도 한다.

### 2.4.1 테스트를 위한 애플리케이션 컨텍스트 관리

#### 테스트 메소드의 컨텍스트 공유
하나의 테스트 클래스 내의 테스트 메소드는 같은 애플리케이션 컨텍스트를 공유해서 사용할 수 있다.

스프링의 JUnit 확장기능(@RunWith)은 테스트가 실행되기 전에 딱 한 번만 애플리케이션 컨텍스트를 만들어두고,
테스트 오브젝트가 만들어질 때마다 특별한 방법을 이용해 애플리케이션 컨텍스트 자신을 테스트 오브젝트의 특정 필드에 주입해주는 것이다.

#### 테스트 클래스의 컨텍스트 공유
여러개의 테스트 클래스가 있는데 모두 같은 설정파일을 가진 애플리케이션 컨텍스트를 사용한다면,
스프링은 테스트 클래스 사이에서도 애플리케이션 컨텍스트를 공유하게 해준다.

### 2.4.2 DI와 테스트

#### DI를 적용하는 이유
- 소프트웨어 개발에서 절대로 바뀌지 않는 것은 없기 때문이다.
- 클래스의 구현 방식은 바뀌지 않는다고 하더라도 인터페이스를 두고 DI를 적용하게 해두면 다른 차원의 서비스 기능을 도입할 수 있기 때문이다.
- 단지 효율적인 테스트를 손쉽게 만들기 위해서라도 DI를 적용해야 한다.
DI는 테스트가 작은 단위의 대상에 대해 독립적으로 만들어지고 실행되게 하는 데 중요한 역할을 한다.
  
#### 테스트 코드에 의한 DI
테스트 코드 내에서 직접 DI를 해도 된다.
테스트 중에 변경한 컨텍스트가 뒤의 테스트에 영향을 주지 않게 하기 위해서 @DirtiesContext 애노테이션을 추가해주는게 좋다.

#### 테스트를 위한 별도의 DI 설정
테스트 코드 내에서 직접 DI를 하는 방법은 장점보다 단점이 많다.
때문에, 아예 테스트에서 사용될 DataSource 클래스가 빈으로 정의된 테스트 전용 설정파일을 따로 만들어두는 방법을 이용해도 된다.

테스트 환경에 적합한 구성을 가진 설정파일을 이용해서 테스트를 진행하면 애플리케이션 컨텍스트도 한 개만 만들어서 모든 테스트에서 공유할 수 있다.

#### DI를 이용한 테스트 방법 선택
- 항상 스프링 컨테이너 없이 테스트할 수 있는 방법을 가장 우선적으로 고려하자. 
이 방법이 테스트 수행 속도가 가장 빠르고 테스트 자체가 간결하다.
- 여러 오브젝트와 복잡한 의존관계를 갖는 오브젝트에 대한 테스트시에는 스프링의 설정을 이용한 DI 방식의 테스트를 이용하면 편리하다.
- 예외적인 의존관계를 강제로 구성해서 테스트 해야 할 때는 테스트 코드 내에서 직접 DI 를 하는 방법을 이용하면 된다.

## 2.5 학습 테스트로 배우는 스프링
자신이 만들지 않은 프레임워크나 다른 개발팀에서 만들어서 제공한 라이브러리 등에 작성하는 테스트를 **학습테스트(learning test)** 라고 한다.

### 2.5.1 학습 테스트의 장점
- 다양한 조건에 따른 기능을 손쉽게 확인해볼 수 있다.
- 학습 테스트 코드를 실제 개발에서 샘플 코드로 참고할 수 있다.
- 프레임워크나 제품을 업그레이드할 때 호환성 검증을 도와준다.
- 테스트 작성에 대한 좋은 훈련이 된다.
- 문서를 읽는 것 보다 직접 코드를 작성해보면서, 새로운 기술을 공부하는 과정이 즐거워진다.

### 2.5.3 버그 테스트
코드에 오류가 있을 때 그 오류를 가장 잘 드러내줄 수 있는 테스트를 **버그 테스트(bug test)** 라고 한다.

버그 테스트는 버그가 원인이 되서 실패하도록 만들어야 한다. 그러고 나서 테스트가 성공할 수 있도록 애플리케이션 코드를 수정한다.
테스트가 성공하면 버그는 해결된 것이다.

#### 버그 테스트의 장점
- 불충분했던 테스트를 보완해줘서 테스트의 완성도를 높여준다.
- 테스트를 작성하면서 버그의 내용을 명확하게 분석하게 해준다.
- 기술적인 문제를 해결하는 데 도움이 된다.

## 2.6 정리
- 테스트는 자동화돼야 하고, 빠르게 실행할 수 있어야 한다.
- main() 테스트 대신 JUnit 프레임워크를 이용한 테스트 작성이 편리하다.
- 테스트 결과는 일관성이 있어야 한다. 코드의 변경 없이 환경이나 테스트 실행 순서에 따라서 결과가 달라지면 안 된다.
- 테스트는 포괄적으로 작성해야 한다. 충분한 검증을 하지 않는 테스트는 없는 것 보다 나쁠 수 있다.
- 코드 작성과 테스트 수행의 간격이 짧을수록 효과적이다.
- 테스트하기 쉬운 코드가 좋은 코드이다.
- 테스트를 먼저 만들고 테스트를 성공시키는 코드를 만들어가는 테스트 주도 개발 방법도 유용하다.
- 테스트 코드도 애플리케이션 코드와 마찬가지로 적절한 리팩토링이 필요하다.
- @Before, @After를 사용해서 테스트 메소드들의 공통 준비 작업과 정리 작업을 처리할 수 있다.
- 스프링 테스트 컨텍스트 프레임워크를 이용하면 테스트 성능을 향상시킬 수 있다.
- 동일한 설정파일을 사용하는 테스트는 하나의 애플리케이션 컨텍스트를 공유한다.
- @Autowired를 사용하면 컨텍스트의 빈을 테스트 오브젝트에 DI 할 수 있다.
- 기술의 사용 방법을 익히고 이해를 돕기 위해 학습 테스트를 작성하자.
- 오류가 발견될 경우 그에 대한 버그 테스트를 만들어두면 유용하다.